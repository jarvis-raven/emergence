# Emergence F040b — Full Stack Fresh Agent Test
# Proper flow: OpenClaw onboard → Install Emergence → First Light
FROM node:22-slim

# System deps (including cron)
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-pip python3-venv git curl procps cron sudo && \
    rm -rf /var/lib/apt/lists/*

# Install OpenClaw globally
RUN npm install -g openclaw

# Create agent user with sudo access for cron
RUN useradd -m -s /bin/bash agent && \
    echo "agent ALL=(ALL) NOPASSWD: /usr/sbin/service, /usr/sbin/cron" >> /etc/sudoers

# Copy emergence source (as root first for correct permissions)
COPY . /home/agent/emergence/
RUN chown -R agent:agent /home/agent/emergence/

# Install Room dependencies (as root to avoid permission issues)
WORKDIR /home/agent/emergence/room
RUN npm install --production 2>/dev/null || true

# Set up working directory
WORKDIR /home/agent

# Switch to agent user
USER agent

# Expose ports: Room (7373), OpenClaw Gateway (configurable)
EXPOSE 7373 18789

# Startup script that handles the full flow
COPY --chown=agent:agent tests/docker/entrypoint.sh /home/agent/entrypoint.sh
RUN chmod +x /home/agent/entrypoint.sh

# Start with entrypoint script
CMD ["/home/agent/entrypoint.sh"]
